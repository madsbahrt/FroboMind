<launch>

<param name="use_sim_time" value="true"/>

<group ns="fmSensors">
	<node pkg="fmSensors" name="IMU" type="vectornav_imu_node" output="screen"> 
	    <param name="subscribe_topic_id" value="/fmCSP/com0_rx" />
		<param name="publish_topic_id" value="/fmSensors/IMU" />
		<param name="frame_id" value="imu_link" />
		<param name="cov_x" value="0.001"/>
		<param name="cov_y" value="0.001"/>
		<param name="cov_z" value="0.001"/>
	</node>
	
	<node pkg="fmSensors" name="GPGGA_PARSER" type="gps_node" output="screen"> 
	    <param name="subscribe_topic_id" value="/fmCSP/S0_rx" />
		<param name="publish_topic_id" value="/fmSensors/gpgga" />
	</node>
</group>

<group ns="fmExtractors">
	<node pkg="fmExtractors" name="UTM_TO_ODOM" type="utm_to_odom" output="screen"> 
	    <param name="subscribe_topic_id" value="/fmExtractors/utm" />
		<param name="publish_topic_id" value="/fmExtractors/gps_odom" />
		<param name="odom_frame_id" value="base_footprint" />
		<param name="tf_frame_id" value="world" />
		<param name="tf_child_frame_id" value="tf_gps_odom" />
	</node>
	
	<node pkg="fmExtractors" name="GPGGA_TO_UTM" type="gps_state" output="screen"> 
	    <param name="subscribe_topic_id" value="/fmSensors/gpgga" />
		<param name="publish_topic_id" value="/fmExtractors/utm" />
	</node>
	
	<node pkg="fmExtractors" name="wheel_odometry" type="simple_odom">
        <param name="conv_ticks_to_meter_left" value="0.000183105"/>
        <param name="conv_ticks_to_meter_right" value="0.000183105"/> 
        <param name="distance_between_wheels_in_meter" value="0.8"></param>
        <param name="max_time_diff" value="1"></param>      
        <param name="publisher_topic"        value="/fmExtractors/wheel_odom" />
        <param name="enc_r_subscriber_topic" value="/fmSensors/encoder_right" />
        <param name="enc_l_subscriber_topic" value="/fmSensors/encoder_left" />
    </node>
</group>

<group ns="fmProcessors">
 <node pkg="fmProcessors" type="odom_estimation" name="Odometry_Estimation" output="screen">
	<param name="imu_subscriber_topic" value="/fmSensors/IMU"></param>
	<param name="odom_subscriber_topic"     value="/fmExtractors/wheel_odom"></param>
	<param name="gps_odom_subscriber_topic" value="/fmExtractors/gps_odom"></param>
	<param name="odom_estimate_publisher_topic" value="/fmProcessors/odom_estimate"></param>
  </node>
</group>

<group ns="viz">
	 <node pkg="rviz" name="visualization" type="rviz" args="-d $(find fmSim)/conf/odom_viz.vcg"/>
	 <node pkg="fmTools" name="imu_marker" type="imu_marker">
	 	<param name="imu_subscriber_topic" value="/fmSensors/IMU"></param>
	 	<param name="marker_publisher_topic" value="/fmTools/imu_marker"></param>
	 	<param name="frame_id" value="base_footprint"></param>
	 </node>
</group>

<node pkg="tf" type="static_transform_publisher" name="imu_link_broadcaster" args="0.8 0.0 0.8 0 0 0 base_footprint imu_link 100"/>
<node pkg="tf" type="static_transform_publisher" name="gps_link_broadcaster" args="0.8 0.0 0.8 0 0 0 base_footprint gps_link 100"/>
<node pkg="tf" type="static_transform_publisher" name="laser_link_broadcaster" args="1.2 0 0.2 0 0 0 base_footprint laser_link 10"/>
<node pkg="tf" type="static_transform_publisher" name="base_link_broadcaster" args="0 0 0 0 0 0 base_footprint base_link 100"/>
<node pkg="tf" type="static_transform_publisher" name="wheel_link_broadcaster" args="0.0 0 0.0 0 0 0 base_footprint wheel_link 100"/>

<!-- Create a transform which moves base footprint back where rviz can see it due to utm coordinates  -->
<node pkg="tf" type="static_transform_publisher" name="utm_link_broadcaster" args="-588797 -6137255 0 0 0 0 map odom_combined 100"/>


</launch>
